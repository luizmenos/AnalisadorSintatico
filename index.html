<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análisador Sintático Top-Down</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="css/fixedColumns.bootstrap5.min.css">
    <link rel="stylesheet" href="css/fixedHeader.bootstrap5.min.css">
    <link rel="stylesheet" href="css/fontawesome-all.min.css">
    <link rel="stylesheet" href="css/style.css">

</head>

<body>

    <div class="container-fluid">
        <div class="row">
            <div class="col-md-3">
                <div class="accordion" id="accordionGramatica">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingGramatica">
                            <button class="accordion-button fw-bold text-secondary-emphasis" type="button"
                                data-bs-toggle="collapse" data-bs-target="#collapseGramatica" aria-expanded="false"
                                aria-controls="collapseGramatica">
                                Gramática
                            </button>
                        </h2>
                        <div id="collapseGramatica" class="accordion-collapse collapse show"
                            aria-labelledby="headingGramatica" data-bs-parent="#accordionGramatica">
                            <div class="accordion-body">
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item">S::= aAb | bBc | cCd</li>
                                    <li class="list-group-item">A::= aDa | bAb</li>
                                    <li class="list-group-item">B::= bCD | &epsilon;</li>
                                    <li class="list-group-item">C::= cAB | aDb</li>
                                    <li class="list-group-item">D::= dSa | cBd</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="accordion" id="accordionFirstFollow">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingFirstFollow">
                            <button class="accordion-button fw-bold text-secondary-emphasis" type="button"
                                data-bs-toggle="collapse" data-bs-target="#collapseFirstFollow" aria-expanded="false"
                                aria-controls="collapseFirstFollow">
                                First / Follow
                            </button>
                        </h2>
                        <div id="collapseFirstFollow" class="accordion-collapse collapse show"
                            aria-labelledby="headingFirstFollow" data-bs-parent="#accordionFirstFollow">
                            <div class="accordion-body">
                                <div class="row w-100">
                                    <div class="col-md-6">
                                        <div class="list-group">
                                            <div class="list-group-item">
                                                <div class="d-flex w-100 justify-content-between border-bottom mb-1">
                                                    <h5 class="mb-1">First</h5>
                                                </div>
                                                <p class="mb-1">S = a, b, c</p>
                                                <p class="mb-1">A = a, b</p>
                                                <p class="mb-1">B = b, &epsilon;</p>
                                                <p class="mb-1">C = a, c</p>
                                                <p class="mb-1">D = c, d</p>

                                            </div>
                                        </div>

                                    </div>
                                    <div class="col-md-6">
                                        <div class="list-group">
                                            <div class="list-group-item">
                                                <div class="d-flex w-100 justify-content-between border-bottom mb-1">
                                                    <h5 class="mb-1">Follow</h5>
                                                </div>
                                                <p class="mb-1">S = $, a</p>
                                                <p class="mb-1">A = b, c, d</p>
                                                <p class="mb-1">B = c, d</p>
                                                <p class="mb-1">C = c, d</p>
                                                <p class="mb-1">D = a, b</p>

                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="accordion" id="accordionTabelaParsing">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingTabelaParsing">
                            <button class="accordion-button fw-bold text-secondary-emphasis" type="button"
                                data-bs-toggle="collapse" data-bs-target="#collapseTabelaParsing" aria-expanded="false"
                                aria-controls="collapseTabelaParsing">
                                Tabela de Parsing
                            </button>
                        </h2>
                        <div id="collapseTabelaParsing" class="accordion-collapse collapse show"
                            aria-labelledby="headingTabelaParsing" data-bs-parent="#accordionTabelaParsing">
                            <div class="accordion-body">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover table-striped text-center">
                                        <thead>
                                            <tr>
                                                <th></th>
                                                <th>a</th>
                                                <th>b</th>
                                                <th>c</th>
                                                <th>d</th>
                                                <th>$</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr id="regra-S" class="table-info border-info">
                                                <td class="text-info-emphasis">S</td>
                                                <td class="text-info-emphasis"
                                                    onclick="desenvolveCaminho('S', 'aAb', 'a')">S -> aAb</td>
                                                <td class="text-info-emphasis"
                                                    onclick="desenvolveCaminho('S', 'bBc', 'b')">S -> bBc</td>
                                                <td class="text-info-emphasis"
                                                    onclick="desenvolveCaminho('S', 'cCd', 'c')">S -> cCd</td>
                                                <td class="text-info-emphasis">-</td>
                                                <td class="text-info-emphasis">-</td>
                                            </tr>
                                            <tr id="regra-A">
                                                <td>A</td>
                                                <td onclick="desenvolveCaminho('A', 'aDa', 'a')">A -> aDa</td>
                                                <td onclick="desenvolveCaminho('A', 'bAb', 'b')">A -> bAb</td>
                                                <td>-</td>
                                                <td>-</td>
                                                <td>-</td>
                                            </tr>
                                            <tr id="regra-B">
                                                <td>B</td>
                                                <td>-</td>
                                                <td onclick="desenvolveCaminho('B', 'bCD', 'b')">B -> bCD</td>
                                                <td onclick="desenvolveCaminho('B', '', 'c')">B -> &epsilon;</td>
                                                <td onclick="desenvolveCaminho('B', '', 'd')">B -> &epsilon;</td>
                                                <td>-</td>
                                            </tr>
                                            <tr id="regra-C">
                                                <td>C</td>
                                                <td onclick="desenvolveCaminho('C', 'aDb', 'a')">C -> aDb</td>
                                                <td>-</td>
                                                <td onclick="desenvolveCaminho('C', 'cAB', 'c')">C -> cAB</td>
                                                <td>-</td>
                                                <td>-</td>
                                            </tr>
                                            <tr id="regra-D">
                                                <td>D</td>
                                                <td>-</td>
                                                <td>-</td>
                                                <td onclick="desenvolveCaminho('D', 'cBd', 'c')">D -> cBd</td>
                                                <td onclick="desenvolveCaminho('D', 'dSa', 'd')">D -> dSa</td>
                                                <td>-</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <button class="btn btn-info" disabled id="restauraDeriv"
                                            onclick="restauraTabela()">Resetar
                                            Derivações</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">Sentença</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-9">
                                <label for="sentenca">Sentença</label>
                                <input type="text" id="sentenca" name="sentenca" onblur="validarSentenca(this.value)"
                                    class="form-control">
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <button type="button" onclick="gerarSentenca()" class="btn btn-primary">Sentença
                                    Aleatória </button>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card" id="validationCard">
                    <div class="card-header">
                        <h5 class="card-title">Validação</h5>
                    </div>
                    <div class="card-body">
                        <button type="button" class="btn btn-primary" onclick="validacao('direta')"
                            disabled>Direta</button>
                        <button type="button" class="btn btn-secondary" onclick="validacao('passo')" disabled>Passo a
                            Passo</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        Tabela de Validação
                    </div>
                    <div class="card-body">
                        <table class="table table-hover table-bordered table-striped" id="tabelaValidacao">
                            <thead>
                                <tr>
                                    <th>Pilha</th>
                                    <th>Entrada</th>
                                    <th>Ação</th>
                                </tr>
                            </thead>
                            <tbody>

                            </tbody>
                        </table>
                    </div>
                    <div class="card-footer text-end d-none" id="footerPasso">
                        <button class="btn btn-success" onclick="proximoPasso()">Próximo Passo</button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/dataTables.min.js"></script>
    <script src="js/dataTables.bootstrap5.min.js"></script>
    <script src="js/dataTables.fixedHeader.min.js"></script>
    <script src="js/fixedHeader.bootstrap5.min.js"></script>
    <script src="js/sweetalert2.all.min.js"></script>
    <script>
        let parsing = {
            'S': {
                'a': ['aAb'],
                'b': ['bBc'],
                'c': ['cCd']
            },
            'A': {
                'a': ['aDa'],
                'b': ['bAb']
            },
            'B': {
                'b': ['bCD'],
                'c': [''],
                'd': ['']
            },
            'C': {
                'a': ['aDb'],
                'c': ['cAB']
            },
            'D': {
                'c': ['cBd'],
                'd': ['dSa']
            },
            '$': {
                '$': ''
            }
        };

        let alfabeto = ['a', 'b', 'c', 'd'];
        let historicoDefinitivo = [];

        gerarSentenca = () => {
            let sentencaValida = "";

            while (true) {
                let sentenca = "";
                let pilha = ['$', 'S'];
                let pilhaValida = true;
                let historico = [];
                let producaoEscolhida = '';
                let iteracoes = 0;
                let entrada = [];

                while (pilha.length > 0) {
                    iteracoes++;
                    historico.push({
                        pilhaAntes: [...pilha]
                    });
                    let simboloAtual = pilha.pop();
                    historico[historico.length - 1].simbolo = simboloAtual;

                    if (alfabeto.includes(simboloAtual)) {
                        sentenca += simboloAtual;
                        producaoEscolhida = 'ler ' + simboloAtual;

                        if (sentenca.length > 20) {
                            pilhaValida = false;
                            break;
                        }
                    } else if (parsing[simboloAtual]) {
                        let producoes = Object.values(parsing[simboloAtual]).flat();
                        producaoEscolhida = producoes[Math.floor(Math.random() * producoes.length)];

                        for (let i = producaoEscolhida.length - 1; i >= 0; i--) {
                            pilha.push(producaoEscolhida[i]);
                        }
                    }

                    historico[historico.length - 1].producao = producaoEscolhida;
                    historico[historico.length - 1].pilhaDepois = [...pilha];

                    if (historico[historico.length - 1].pilhaAntes.length == 1 && historico[historico.length - 1].pilhaAntes[0] == '$' && simboloAtual == '$') {
                        historico[historico.length - 1].producao = "Aceito em " + iteracoes;
                        break;
                    }
                }

                if (pilhaValida && sentenca.length <= 20) {
                    sentencaValida = sentenca;
                    historicoDefinitivo = historico;
                    break;
                }
            }

            $('#sentenca').val(sentencaValida);
            $('#validationCard button').attr('disabled', false);

            let minhaSentenca = sentencaValida + '$';
            minhaSentenca = minhaSentenca.split("");
            historicoDefinitivo.forEach((linha) => {

                linha.entrada = [...minhaSentenca];
                if (linha.producao.includes('ler')) {
                    minhaSentenca.shift();
                }
            });

            console.log(historicoDefinitivo);
        }

        const tabela = new DataTable('#tabelaValidacao', {
            fixedHeader: true,
            paging: false,
            searching: false,
            ordering: false,
            info: false,
            lengthChange: false,
            scrollX: false
        });

        let historicoCopia;
        let deubom = true;

        validacao = (tipo) => {
            if (!$('#footerPasso').hasClass('d-none')) {
                $('#footerPasso').addClass('d-none');
            }

            tabela.clear().draw();

            deubom = validarSentenca($('#sentenca').val());

            historicoCopia = historicoDefinitivo;

            if (tipo == 'passo') {
                if ($('#footerPasso').hasClass('d-none')) {
                    $('#footerPasso').removeClass('d-none');
                }
                proximoPasso();
            } else if (tipo == 'direta') {
                historicoDefinitivo.forEach((linhaHist, index) => {
                    let linha = tabela.row.add([
                        linhaHist.pilhaAntes.join(""),
                        linhaHist.entrada.join(""),
                        linhaHist.producao.includes('ler') || linhaHist.simbolo == '$'
                            ? (linhaHist.producao === '' ? '&epsilon;' : linhaHist.producao)
                            : linhaHist.simbolo + ' -> ' + (linhaHist.producao === '' ? '&epsilon;' : linhaHist.producao)
                    ]).draw(false);
                    if (index === historicoDefinitivo.length - 1) {
                        if (deubom) {
                            $(tabela.row(':last').node()).addClass('table-success');
                            $(tabela.row(':last').node())
                                .find('td')
                                .each(function () {
                                    $(this).addClass('text-success-emphasis fw-bold');
                                });
                        } else {
                            $(tabela.row(':last').node()).addClass('table-danger');
                            $(tabela.row(':last').node())
                                .find('td')
                                .each(function () {
                                    $(this).addClass('text-danger-emphasis fw-bold');
                                });
                        }
                    }
                });

            }
        }

        proximoPasso = () => {
            let passo = historicoCopia.shift();
            tabela.row.add([
                passo.pilhaAntes.join(""),
                passo.entrada.join(""),
                passo.producao.includes('ler') || passo.simbolo == '$'
                    ? (passo.producao === '' ? '&epsilon;' : passo.producao)
                    : passo.simbolo + ' -> ' + (passo.producao === '' ? '&epsilon;' : passo.producao)
            ]).draw(false);

            if (historicoCopia.length == 0) {
                if (deubom) {
                    $(tabela.row(':last').node()).addClass('table-success');
                    $(tabela.row(':last').node())
                        .find('td')
                        .each(function () {
                            $(this).addClass('text-success-emphasis fw-bold');
                        });
                } else {
                    $(tabela.row(':last').node()).addClass('table-danger');
                    $(tabela.row(':last').node())
                        .find('td')
                        .each(function () {
                            $(this).addClass('text-danger-emphasis fw-bold');
                        });
                }
            }
        }

        validarSentenca = (sentenca) => {
            if (historicoDefinitivo.length > 0) historicoDefinitivo = [];
            let pilha = ['$', 'S'];
            let entrada = sentenca.split("");
            entrada.push('$');
            let historico = [];
            let iteracoes = 0;

            while (pilha.length > 0) {
                iteracoes++;

                let simboloPilha = pilha.pop();
                let simboloEntrada = entrada[0];

                let linhaHistorico = {
                    pilhaAntes: [...pilha, simboloPilha],
                    simbolo: simboloPilha,
                    entrada: [...entrada],
                    producao: '',
                    pilhaDepois: null
                };
                // console.log(simboloPilha);
                if (alfabeto.includes(simboloPilha)) {
                    if (simboloPilha === simboloEntrada) {
                        entrada.shift();
                        linhaHistorico.producao = 'ler ' + simboloPilha;
                    } else {
                        linhaHistorico.producao = `Erro em: ${iteracoes}`;
                        historico.push(linhaHistorico);
                        // console.log(historico);
                        break;
                        //  Swal.fire("", "Sentença inválida 1", "error");
                        // return false;
                    }
                }
                else if (parsing[simboloPilha]) {
                    const producoes = parsing[simboloPilha][simboloEntrada];
                    const producao = Array.isArray(producoes) ? producoes[0] : producoes;

                    if (producao == null || producao == undefined) {
                        linhaHistorico.producao = `Erro em: ${iteracoes}`;
                        historico.push(linhaHistorico);
                        // console.log(historico);
                        break;
                        //  Swal.fire("", "Sentença inválida 2", "error");
                        // return false;
                    }

                    linhaHistorico.producao = producao;
                    producao.split("").reverse().forEach(s => {
                        if (s !== '') pilha.push(s);
                    });
                } else {
                    linhaHistorico.producao = `Erro em: ${iteracoes}`;
                    historico.push(linhaHistorico);
                    break;
                    // console.log(historico);
                    //  Swal.fire("", "Sentença inválida 3", "error");
                    // return false;
                }
                if (simboloPilha === '$' && simboloEntrada === '$') {
                    linhaHistorico.producao = "Aceito em " + iteracoes;

                    // console.log(historico);
                    //  Swal.fire("", "Sentença válida", "success");

                }
                linhaHistorico.pilhaDepois = [...pilha];
                historico.push(linhaHistorico);
                // if (simboloPilha === '$' && simboloEntrada === '$') {
                //     return true;
                // }
            }
            historicoDefinitivo = historico;
            $('#validationCard button').attr('disabled', false);

            if (historico[historico.length - 1].producao.includes('Erro')) {
                // console.log('aqui');
                return false;
            } else if (historico[historico.length - 1].producao.includes('Aceito')) {
                // console.log('aca');
                return true;
            }
            Swal.fire("", "Sentença inválida fim", "error");
            return false;
        };

        let pilha = ['$', 'S'];
        let sentenca = "";
        let temErro = false;
        atualizaTela = () => {
            $('#sentenca').val(sentenca);
            validarSentenca(sentenca);
        }

        desenvolveCaminho = (regra, producao, terminal) => {

            const simboloTopo = pilha.pop();

            console.log(typeof simboloTopo);
            if (typeof simboloTopo === "undefined") {
                Swal.fire('A sentença possui erros ou está completa', 'Você pode realizar a validação da mesma para verificar onde ocorreu o erro, ou resetar as derivações clicando em "Resetar Derivações"', "info");
                return;
            }

            if (simboloTopo == undefined || simboloTopo == '$') {
                Swal.fire('', 'Clique em "Resetar Derivações" para poder derivar novamente', "info");
                return;
            }

            if (simboloTopo !== regra) {
                if (!parsing[simboloTopo] || !parsing[simboloTopo][terminal]) {
                    Swal.fire("Erro na derivação", `Não há produção válida para o topo da pilha '${simboloTopo}' com o terminal '${terminal}'. A sentença não pode ser mais derivada.`, 'error');
                    pilha.push(simboloTopo);

                    return;
                }
                if (typeof alfabeto[simboloTopo] !== "undefined") {
                    Swal.fire("", `Erro: não é mais possível derivar, pois o topo da pilha é o terminal ${simboloTopo}`, "error");

                } else {
                    Swal.fire("", `Aviso: topo da pilha é '${simboloTopo}', esperado '${regra}'`, "warning");
                }
                pilha.push(simboloTopo);
                return;
            }




            for (let i = producao.length - 1; i >= 0; i--) {
                let simbolo = producao[i];
                if (simbolo !== '') pilha.push(simbolo);
            }

            if (pilha.length && pilha[pilha.length - 1] === terminal) {
                sentenca += terminal;
                pilha.pop();
            }

            $('#restauraDeriv').removeAttr('disabled');
            atualizaTela();
            destacarProximaRegra();
        }

        destacarProximaRegra = () => {
            document.querySelectorAll('tr[id^="regra-"]').forEach(tr => {
                tr.classList.remove('table-info');
                tr.classList.remove('border-info');
            });

            document.querySelectorAll('tr[id^="regra-"] td').forEach(td => {
                td.classList.remove('text-info-emphasis');
            });

            const simbolo = pilha[pilha.length - 1];
            if (typeof parsing[simbolo] !== 'undefined') {
                const linha = document.getElementById('regra-' + simbolo);
                if (linha) {
                    linha.classList.add('table-info');
                    linha.classList.add('border-info');
                    $(linha).find('td').each(function () {
                        $(this).addClass('text-info-emphasis');
                    });
                }
            }
            return;

        }

        restauraTabela = () => {
            $('#restauraDeriv').attr('disabled', true);

            pilha = ['$', 'S'];
            sentenca = '';
            $('#sentenca').val('');
            document.querySelectorAll('tr[id^="regra-"]').forEach(tr => {
                tr.classList.remove('table-info');
                tr.classList.remove('border-info');
            });

            document.querySelectorAll('tr[id^="regra-"] td').forEach(td => {
                td.classList.remove('text-info-emphasis');
            });

            $('#regra-S').addClass('border-info table-info');
            $('#regra-S td').addClass('text-info-emphasis');
        }

        // Tudo isso aqui embaixo só pra não deixar o Luiz colocar espaço em branco no campo, show de bola
        
        $(document).ready(function () {
            $('#sentenca').on('keydown', function (e) {
                if (e.key === " " || e.code === "Space") {
                    e.preventDefault();
                }
            });
            $('#sentenca').on('paste', function (e) {
                e.preventDefault();
                var texto = (e.originalEvent || e).clipboardData.getData('text');
                texto = texto.replace(/\s+/g, '');
                document.execCommand("insertText", false, texto);
            });
            $('#sentenca').on('blur', function () {
                $(this).val($(this).val().replace(/\s+/g, ''));
            });
        });
    </script>
</body>

</html>
